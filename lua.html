<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Lua Configuration &mdash; RT Retrieval Framework  documentation</title>
    
    <link rel="stylesheet" href="_static/better.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="RT Retrieval Framework  documentation" href="index.html" />
    <link rel="next" title="Running Jobs" href="running_jobs.html" />
    <link rel="prev" title="Runs Setup" href="runs_setup.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
      <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  </head>
  <body role="document">
    <header id="pageheader"><h1><a href="index.html ">
        RT Retrieval Framework  documentation
    </a></h1></header>
  <div class="related top">
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="runs_setup.html" title="Previous document">Runs Setup</a>
        </li>
        <li>
          <a href="running_jobs.html" title="Next document">Running Jobs</a>
          &rarr;
        </li>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="index.html">Home</a></li> 
    </ul>
  </nav>
  </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="lua-configuration">
<h1>Lua Configuration<a class="headerlink" href="#lua-configuration" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="http://www.lua.org">Lua</a> is a lightweight, embeddable scripting language. It was chosen to manage the configuration over a declarative approach due to its flexibility. The code itself was written in a manner such that the C++ portions are components that have minimal dependency on each other and adhere to well defined interfaces. The Lua configuration selects which components are used and makes them aware of each other. The configuration files themselves are written in layers where more specific configurations extend the general. At the bottom level are configurations that implement instrument specific arrangements of components. These files specify which files are involved in the processing as well as algorithmic choices.  At this level the Lua code looks like declarative keyword/value configuration files. This approach combines flexibility with simplicity for end users.</p>
<p>The configuration loads input data, building a priori and initial guess vectors as it processes components. Components are connected to each other and passed their input in a hierarchal manner. Dependent components are loaded first so they are initialized and can be passed to components that need them. The top most level is the forward model component. It is created last and when ready called to start iterative execution as described in previous sections.</p>
<div class="section" id="indexing">
<h2>Indexing<a class="headerlink" href="#indexing" title="Permalink to this headline">¶</a></h2>
<p>It is worth noting that Lua uses 1-based indexing unlike the C++ code that is wrapping. Therefore care must be made when interacting with objects. If the object is pure Lua then use 1-based indexing. If you are dealing with, say a vector from the C++ world then it will be 0-based.</p>
</div>
<div class="section" id="organization">
<h2>Organization<a class="headerlink" href="#organization" title="Permalink to this headline">¶</a></h2>
<p>There are many separate Lua files involved in a single execution. These files have been organized such that the files with more general functionality are extended by files which use more specific implementation details. One of the configuration Lua files typically extends another by using the Lua <code class="docutils literal"><span class="pre">require</span></code> statement and Lua&#8217;s table inheritance.</p>
<p>The graph below shows the organizational hierarchy for the OCO configuration:</p>
<p class="graphviz">
<img src="_images/graphviz-c81bdd20a77bcd6b59184f729947cc0efe9925b9.png" alt="digraph file_hierarchy {
    rankdir=BT;
    config_common [label = &quot;config_common.lua&quot;, style=filled, fillcolor=bisque];
    oco_config [label = &quot;oco_config.lua&quot;, style=filled, fillcolor=gold];
    oco_base [label = &quot;oco_base_config.lua&quot;, style=filled, fillcolor=gold];
    config [label = &quot;config.lua&quot;, style=filled, fillcolor=gold];
    config -&gt; oco_base -&gt; oco_config -&gt; config_common;
}" />
</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>config_common.lua</td>
<td>Common routines for any instrument type</td>
</tr>
<tr class="row-even"><td>oco_config.lua</td>
<td>Common routines for OCO configuration</td>
</tr>
<tr class="row-odd"><td>oco_base_config.lua</td>
<td>Base configuration of how common components are connected</td>
</tr>
<tr class="row-even"><td>config.lua</td>
<td>Empty config meant to be copied by users for modification</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="config-common">
<h2>Config Common<a class="headerlink" href="#config-common" title="Permalink to this headline">¶</a></h2>
<p>As the table above states, <code class="docutils literal"><span class="pre">config_common.lua</span></code> is collection of common routines that are not instrument specific. It defines <code class="docutils literal"><span class="pre">ConfigCommon</span></code>, a table object which contains the configuration and also serves as a name space. The most important method is <code class="docutils literal"><span class="pre">do_config</span></code>. It is called from the lowest level configuration file to begin the process of instantiating objects.</p>
<p>The framework objects are created through Lua <code class="docutils literal"><span class="pre">Creator</span></code> classes. These classes define how a particular functionality is instantiated. They also provide an initial guess value, objects to be added to the state vector and objects to be registered into the output file. The <code class="docutils literal"><span class="pre">Creator</span></code> class also handles calling any other <code class="docutils literal"><span class="pre">Creator</span></code> objects that it depends on.</p>
<p>The hierarchy of <code class="docutils literal"><span class="pre">Creator</span></code> objects forms a tree which at the top is the one <code class="docutils literal"><span class="pre">Creator</span></code> that <code class="docutils literal"><span class="pre">do_config</span></code> knows about directly, the <code class="docutils literal"><span class="pre">fm</span></code> creator. All other <code class="docutils literal"><span class="pre">Creator</span></code> objects are dependencies of this one or other <code class="docutils literal"><span class="pre">Creator</span></code> objects. The graph below shows the organization of the <code class="docutils literal"><span class="pre">Creator</span></code> objects in the current OCO configuration.</p>
<p class="graphviz">
<img src="_images/graphviz-7757b46c280c7a8d9dbb927d33ea564c7b1a5770.png" alt="graph config_hierarchy {
    fm -- common;
    fm -- spec_win;
    fm -- spec_samp;
    fm -- spectrum_effect [minlen=2];
    fm -- atmosphere [minlen=7];
    fm -- instrument [minlen=2];
    fm -- rt;
    fm -- state_vector;
    fm -- l1b;

    l1b -- noise;

    instrument -- dispersion;
    instrument -- instrument_correction [minlen=2];
    instrument -- ils_func;
    instrument_correction -- radiance_scaling;

    atmosphere -- pressure;
    atmosphere -- temperature;
    atmosphere -- ground;
    atmosphere -- aerosol;
    atmosphere -- absorber;
    atmosphere -- altitude;

    ground -- lambertian;
    ground -- coxmunk;
    ground -- coxmunk_lambertian;

    spectrum_effect -- fluorescence;
    spectrum_effect -- solar_model [minlen=2];

    solar_model -- doppler_shift;
    solar_model -- solar_absorption [minlen=2];
    solar_model -- solar_continuum;

}" />
</p>
</div>
<div class="section" id="base-config">
<h2>Base Config<a class="headerlink" href="#base-config" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">oco_config.lua</span></code> extends the <code class="docutils literal"><span class="pre">ConfigCommon</span></code> object with <code class="docutils literal"><span class="pre">OcoConfig</span></code> by adding additional <code class="docutils literal"><span class="pre">Creator</span></code> classes and functions. <code class="docutils literal"><span class="pre">oco_base_config.lua</span></code> extends <code class="docutils literal"><span class="pre">OcoConfig</span></code> and declares which <code class="docutils literal"><span class="pre">Creator</span></code> classes are used. It defines the <code class="docutils literal"><span class="pre">fm</span></code> table with nested tables for dependent <code class="docutils literal"><span class="pre">Creator</span></code> classes. Each <code class="docutils literal"><span class="pre">Creator</span></code> block contains a required <code class="docutils literal"><span class="pre">creator</span></code> attributes defining the class to use. Additional attributes can be declared in the block for use by the <code class="docutils literal"><span class="pre">Creator</span></code> object.</p>
<p>An abbreviated portion of the table is duplicated below:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">fm</span> <span class="o">=</span> <span class="p">{</span>
   <span class="n">creator</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">oco_forward_model</span><span class="p">,</span>
   <span class="n">instrument</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">creator</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">ils_instrument</span><span class="p">,</span>
      <span class="n">ils_half_width</span> <span class="o">=</span> <span class="p">{</span> <span class="n">DoubleWithUnit</span><span class="p">(</span><span class="mf">4.09e-04</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">um&quot;</span><span class="p">),</span>
                         <span class="n">DoubleWithUnit</span><span class="p">(</span><span class="mf">1.08e-03</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">um&quot;</span><span class="p">),</span>
                         <span class="n">DoubleWithUnit</span><span class="p">(</span><span class="mf">1.40e-03</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">um&quot;</span><span class="p">)</span> <span class="p">},</span>
      <span class="n">dispersion</span> <span class="o">=</span> <span class="p">{</span>
         <span class="n">creator</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">dispersion_polynomial</span><span class="p">,</span>
         <span class="n">apriori</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">l1b_spectral_coefficient_i</span><span class="p">,</span>
         <span class="n">covariance</span> <span class="o">=</span> <span class="n">OcoConfig</span><span class="p">.</span><span class="n">dispersion_covariance_i</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Instrument/Dispersion&quot;</span><span class="p">),</span>
         <span class="n">number_pixel</span> <span class="o">=</span>
             <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">hdf_read_int_1d</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Instrument/Dispersion/number_pixel&quot;</span><span class="p">),</span>
         <span class="n">retrieved</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
         <span class="n">is_one_based</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="n">ils_func</span> <span class="o">=</span> <span class="p">{</span>
         <span class="n">creator</span> <span class="o">=</span> <span class="n">OcoConfig</span><span class="p">.</span><span class="n">ils_table_l1b</span><span class="p">,</span>
      <span class="p">},</span>
   <span class="p">},</span>
   <span class="n">atmosphere</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">creator</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">atmosphere_oco</span><span class="p">,</span>
      <span class="n">constants</span> <span class="o">=</span> <span class="p">{</span>
         <span class="n">creator</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">default_constant</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="n">pressure</span> <span class="o">=</span> <span class="p">{</span>
         <span class="n">apriori</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">ecmwf_pressure</span><span class="p">,</span>
         <span class="n">covariance</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">hdf_covariance</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Surface_Pressure&quot;</span><span class="p">),</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">hdf_read_double_1d</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Pressure/Pressure_sigma_a&quot;</span><span class="p">),</span>
         <span class="n">b</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">hdf_read_double_1d</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Pressure/Pressure_sigma_b&quot;</span><span class="p">),</span>
         <span class="n">creator</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">pressure_sigma</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="n">temperature</span> <span class="o">=</span> <span class="p">{</span>
         <span class="n">apriori</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">hdf_apriori</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Temperature/Offset&quot;</span><span class="p">),</span>
         <span class="n">covariance</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">hdf_covariance</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Temperature/Offset&quot;</span><span class="p">),</span>
         <span class="n">creator</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">temperature_ecmwf</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="n">absorber</span> <span class="o">=</span> <span class="p">{</span>
         <span class="n">creator</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">absorber_creator</span><span class="p">,</span>
         <span class="n">gases</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="s">CO2&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">H2O&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">O2&quot;</span><span class="p">},</span>
         <span class="n">CO2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">apriori</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">tccon_co2_apriori_ecmwf</span><span class="p">,</span>
            <span class="n">covariance</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">hdf_covariance</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Gas/CO2&quot;</span><span class="p">),</span>
            <span class="n">absco</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">v4.2.0_unscaled/co2_v4.2.0_with_ctm.hdf&quot;</span><span class="p">,</span>
                <span class="n">table_scale</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0038</span><span class="p">,</span> <span class="mf">0.9946</span><span class="p">},</span>
            <span class="n">creator</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">vmr_level</span><span class="p">,</span>
         <span class="p">},</span>
         <span class="n">H2O</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">scale_apriori</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="n">scale_cov</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
            <span class="n">absco</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">v4.2.0_unscaled/h2o_v4.2.0.hdf&quot;</span><span class="p">,</span>
            <span class="n">creator</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">vmr_ecmwf</span><span class="p">,</span>
         <span class="p">},</span>
         <span class="n">O2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">apriori</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">hdf_read_double_1d</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Gas/O2/average_mole_fraction&quot;</span><span class="p">),</span>
            <span class="n">absco</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">v4.2.0_unscaled/o2_v4.2.0_drouin.hdf&quot;</span><span class="p">,</span>
                <span class="n">table_scale</span> <span class="o">=</span> <span class="mf">1.0125</span><span class="p">,</span>
            <span class="n">creator</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">vmr_level_constant_well_mixed</span><span class="p">,</span>
         <span class="p">},</span>
      <span class="p">},</span>
   <span class="p">},</span>
<span class="p">},</span>
</pre></div>
</div>
</div>
<div class="section" id="config-lua">
<h2>config.lua<a class="headerlink" href="#config-lua" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">config.lua</span></code> file for any given instrument is where the <code class="docutils literal"><span class="pre">do_config</span></code> method is called. It is intentionally kept short, with all default behavior kept in <code class="docutils literal"><span class="pre">oco_base_config.lua</span></code> and higher.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">&quot;</span><span class="s">oco_base_config&quot;</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">OcoBaseConfig</span><span class="p">:</span><span class="n">new</span><span class="p">()</span>

<span class="n">config</span><span class="p">:</span><span class="n">do_config</span><span class="p">()</span>
</pre></div>
</div>
<p>For configuration customization, it is standard practice to copy this file and place any changes after the <code class="docutils literal"><span class="pre">config</span></code> object is created and before the call to <code class="docutils literal"><span class="pre">do_config</span></code>. Most changes will take the form of modifying values from the <cite>fm`</cite> table from <code class="docutils literal"><span class="pre">oco_base_config.lua</span></code>.</p>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>The following snippets would all go in a modified <code class="docutils literal"><span class="pre">config.lua</span></code> before the <code class="docutils literal"><span class="pre">do_config</span></code> call. For instance:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">&quot;</span><span class="s">oco_base_config&quot;</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">OcoBaseConfig</span><span class="p">:</span><span class="n">new</span><span class="p">()</span>

<span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">atmosphere</span><span class="p">.</span><span class="n">absorber</span><span class="p">.</span><span class="n">H2O</span><span class="p">.</span><span class="n">retrieved</span> <span class="o">=</span> <span class="kc">false</span>

<span class="n">config</span><span class="p">:</span><span class="n">do_config</span><span class="p">()</span>
</pre></div>
</div>
<p>For the remainder of the examples, we will just show the snippet of code that is added to the config file.</p>
<div class="section" id="toggle-retrieval">
<h3>Toggle Retrieval<a class="headerlink" href="#toggle-retrieval" title="Permalink to this headline">¶</a></h3>
<p>Most creators for items that are not band dependent have the <code class="docutils literal"><span class="pre">retrieved</span></code> attribute for controlling if the value appears in the state vector or not. Here are various items that can be controlled this way:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">atmosphere</span><span class="p">.</span><span class="n">absorber</span><span class="p">.</span><span class="n">H2O</span><span class="p">.</span><span class="n">retrieved</span> <span class="o">=</span> <span class="kc">true</span>
<span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">atmosphere</span><span class="p">.</span><span class="n">absorber</span><span class="p">.</span><span class="n">CO2</span><span class="p">.</span><span class="n">retrieved</span> <span class="o">=</span>  <span class="kc">true</span>
<span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">atmosphere</span><span class="p">.</span><span class="n">pressure</span><span class="p">.</span><span class="n">retrieved</span> <span class="o">=</span> <span class="kc">true</span>
<span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">atmosphere</span><span class="p">.</span><span class="n">temperature</span><span class="p">.</span><span class="n">retrieved</span> <span class="o">=</span> <span class="kc">true</span>
<span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">instrument</span><span class="p">.</span><span class="n">dispersion</span><span class="p">.</span><span class="n">retrieved</span> <span class="o">=</span> <span class="kc">true</span>
</pre></div>
</div>
</div>
<div class="section" id="rayleigh-aerosol-model">
<h3>Rayleigh Aerosol Model<a class="headerlink" href="#rayleigh-aerosol-model" title="Permalink to this headline">¶</a></h3>
<p>To ignore any aerosol particles in the retrieval and instead use only Rayleigh scattering, use the following::</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">atmosphere</span><span class="p">.</span><span class="n">aerosol</span><span class="p">.</span><span class="n">creator</span> <span class="o">=</span> <span class="n">ConfigCommon</span><span class="p">.</span><span class="n">rayleigh_only</span>
</pre></div>
</div>
</div>
<div class="section" id="toggle-retrieval-bands">
<h3>Toggle Retrieval Bands<a class="headerlink" href="#toggle-retrieval-bands" title="Permalink to this headline">¶</a></h3>
<p>By default the OCO retrieval uses all three spectrometer bands. One can pick and choose by using the strings: <code class="docutils literal"><span class="pre">ABO2</span></code>, <code class="docutils literal"><span class="pre">WCO2</span></code>, <code class="docutils literal"><span class="pre">SCO2</span></code> as in the following example of using the A-Band only::</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">&quot;</span><span class="s">single_band_support&quot;</span>
<span class="n">config</span><span class="p">.</span><span class="n">which_spectrometers</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">ABO2&quot;</span>
<span class="n">init_single_band_support</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
<p>Or to use only the two CO2 bands you would use the following:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s2">&quot;</span><span class="s">single_band_support&quot;</span>
<span class="n">config</span><span class="p">.</span><span class="n">which_spectrometers</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">WCO2 SCO2&quot;</span>
<span class="n">init_single_band_support</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="ground-retrieval">
<h3>Ground Retrieval<a class="headerlink" href="#ground-retrieval" title="Permalink to this headline">¶</a></h3>
<p>Since the lambertian ground retrieval contains values for each band separately, the <code class="docutils literal"><span class="pre">retrieved</span></code> attribute will not work. Instead you can use the <code class="docutils literal"><span class="pre">retrieve_bands</span></code> attribute with a table containing a boolean for each band indicating whether or not it should be retrieved. For example to turn off the A-Band lambertian retrieval:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">atmosphere</span><span class="p">.</span><span class="n">ground</span><span class="p">.</span><span class="n">lambertian</span><span class="p">.</span><span class="n">retrieve_bands</span> <span class="o">=</span> <span class="p">{</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span> <span class="p">}</span>
</pre></div>
</div>
<p>Coxmunk retrievals do support the <code class="docutils literal"><span class="pre">retrieved</span></code> attribute and are controlled as follows:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">atmosphere</span><span class="p">.</span><span class="n">ground</span><span class="p">.</span><span class="n">coxmunk</span><span class="p">.</span><span class="n">retrieved</span> <span class="o">=</span> <span class="kc">false</span>
</pre></div>
</div>
</div>
<div class="section" id="absco-tables">
<h3>ABSCO Tables<a class="headerlink" href="#absco-tables" title="Permalink to this headline">¶</a></h3>
<p>The ABSCO tables on the OCO systems are installed in a central location. The <code class="docutils literal"><span class="pre">absco_path</span></code> value in the configuration specifies this location:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">.</span><span class="n">absco_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/groups/algorithm/l2_fp/absco&quot;</span>
</pre></div>
</div>
<p>There is generally no need to change this configuration value unless processing on a different machine. However even then it is best to use the <code class="docutils literal"><span class="pre">abscodir</span></code> environmental variable which if present overrides what is present in the config file.</p>
<p>A second ABSCO path, <code class="docutils literal"><span class="pre">absco_local_path</span></code> is a location where tables can be found on local disk from cluster machines. This is present to speed up processing, but the tables must be copied to each machine for this to be of any use:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">.</span><span class="n">absco_local_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/state/partition1/groups/algorithm/l2_fp/absco&quot;</span>
</pre></div>
</div>
<p>To change which tables are used for each gas the relative path and filename of each table under the <code class="docutils literal"><span class="pre">absco_dir</span></code> path is used::</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">atmosphere</span><span class="p">.</span><span class="n">absorber</span><span class="p">.</span><span class="n">CO2</span><span class="p">.</span><span class="n">absco</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">v4.2.0_unscaled/co2_v4.2.0_with_ctm.hdf&quot;</span>
<span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">atmosphere</span><span class="p">.</span><span class="n">absorber</span><span class="p">.</span><span class="n">H2O</span><span class="p">.</span><span class="n">absco</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">v4.2.0_unscaled/h2o_v4.2.0.hdf&quot;</span>
<span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">atmosphere</span><span class="p">.</span><span class="n">absorber</span><span class="p">.</span><span class="n">O2</span><span class="p">.</span><span class="n">absco</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">v4.2.0_unscaled/o2_v4.2.0_drouin.hdf&quot;</span>
</pre></div>
</div>
<p>The scaling applied to the tables for a gas can be changed with the <code class="docutils literal"><span class="pre">table_scale</span></code> attribute. If the value is an array then you can specify a different scaling per band. If a atomic value is used then the same value is used for all bands::</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">atmosphere</span><span class="p">.</span><span class="n">absorber</span><span class="p">.</span><span class="n">O2</span><span class="p">.</span><span class="n">table_scale</span> <span class="o">=</span> <span class="mf">1.0125</span>
<span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">atmosphere</span><span class="p">.</span><span class="n">absorber</span><span class="p">.</span><span class="n">CO2</span><span class="p">.</span><span class="n">table_scale</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0038</span><span class="p">,</span> <span class="mf">0.9946</span> <span class="p">}</span>
</pre></div>
</div>
<p>Note in the above we just use a single value for O2 since this gas is only ever used in the A-Band. For CO2 we set the value in the A-Band to 1.0 as a placeholder since this gas is never used in that band.</p>
</div>
<div class="section" id="ils-half-width">
<h3>ILS Half Width<a class="headerlink" href="#ils-half-width" title="Permalink to this headline">¶</a></h3>
<p>The half width used in ILS convolution can be controlled band by band. The ILS expects a <code class="docutils literal"><span class="pre">DoubleWithUnit</span></code> object which is simply a class that wraps a value with its unit. The values are set in the <code class="docutils literal"><span class="pre">ils_half_width</span></code> array as shown in this example:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">instrument</span><span class="p">.</span><span class="n">ils_half_width</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DoubleWithUnit</span><span class="p">(</span><span class="mf">4.09e-04</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">um&quot;</span><span class="p">)</span>
<span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">instrument</span><span class="p">.</span><span class="n">ils_half_width</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">DoubleWithUnit</span><span class="p">(</span><span class="mf">1.08e-03</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">um&quot;</span><span class="p">)</span>
<span class="n">config</span><span class="p">.</span><span class="n">fm</span><span class="p">.</span><span class="n">instrument</span><span class="p">.</span><span class="n">ils_half_width</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">DoubleWithUnit</span><span class="p">(</span><span class="mf">1.40e-03</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">um&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="high-resolution-spectra">
<h3>High Resolution Spectra<a class="headerlink" href="#high-resolution-spectra" title="Permalink to this headline">¶</a></h3>
<p>The following option will enable output of high resolution spectra. These values are the raw output of the radiative transfer before the instrument model and solar model are applied. Furthermore, they will be on the high resolution grid used in the radiative transfer. When enabled a new group <code class="docutils literal"><span class="pre">HighResSpectra</span></code> will appear in the output files.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">.</span><span class="n">write_high_res_spectra</span> <span class="o">=</span> <span class="kc">true</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Lua Configuration</a><ul>
<li><a class="reference internal" href="#indexing">Indexing</a></li>
<li><a class="reference internal" href="#organization">Organization</a></li>
<li><a class="reference internal" href="#config-common">Config Common</a></li>
<li><a class="reference internal" href="#base-config">Base Config</a></li>
<li><a class="reference internal" href="#config-lua">config.lua</a></li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#toggle-retrieval">Toggle Retrieval</a></li>
<li><a class="reference internal" href="#rayleigh-aerosol-model">Rayleigh Aerosol Model</a></li>
<li><a class="reference internal" href="#toggle-retrieval-bands">Toggle Retrieval Bands</a></li>
<li><a class="reference internal" href="#ground-retrieval">Ground Retrieval</a></li>
<li><a class="reference internal" href="#absco-tables">ABSCO Tables</a></li>
<li><a class="reference internal" href="#ils-half-width">ILS Half Width</a></li>
<li><a class="reference internal" href="#high-resolution-spectra">High Resolution Spectra</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="runs_setup.html"
                        title="previous chapter">Runs Setup</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="running_jobs.html"
                        title="next chapter">Running Jobs</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/lua.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<form class="search" action="search.html" method="get">
  <input type="text" name="q"
   placeholder="type to search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="related bottom">
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="runs_setup.html" title="Previous document">Runs Setup</a>
        </li>
        <li>
          <a href="running_jobs.html" title="Next document">Running Jobs</a>
          &rarr;
        </li>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="index.html">Home</a></li> 
    </ul>
  </nav>
  </div>
  <footer id="pagefooter">&copy; Copyright 2016 California Institute of Technology. U.S. Government sponsorship acknowledged.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a>
      1.3.6
        with the <a href="http://github.com/irskep/sphinx-better-theme">
          better</a> theme.

  </footer>

  
  </body>
</html>